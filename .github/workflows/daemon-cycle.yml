name: Autonomous CTO Cycle

on:
  schedule:
    # Every 4 hours, offset from the top of the hour to reduce GitHub contention
    - cron: '17 */4 * * *'
  workflow_dispatch:
    # Manual trigger — CEO or CTO can fire a cycle anytime
    inputs:
      reason:
        description: 'Why are you triggering a manual cycle?'
        required: false
        default: 'Manual trigger'

# CRITICAL: Prevent overlapping cycles.
# If a cycle is still running when the next one fires, the new one queues.
# This prevents two agents writing to the same repo simultaneously.
concurrency:
  group: cto-daemon-cycle
  cancel-in-progress: false  # Don't cancel running cycles — let them finish

jobs:
  cto-cycle:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Hard ceiling — kill runaway sessions

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ORG_PAT }}
          fetch-depth: 0  # Full history for git log context

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Claude Agent SDK
        run: npm install @anthropic-ai/claude-agent-sdk tsx

      - name: Configure git identity
        run: |
          git config user.name "CTO-Agent"
          git config user.email "cto-agent@agentic-org.dev"

      - name: Run CTO cycle via SDK harness
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: npx tsx daemon/harness/run-cycle.ts

      - name: Push changes
        if: always()
        run: |
          git add -A
          # Only commit if there are actual changes
          if ! git diff --cached --quiet; then
            echo "Changes detected — committing and pushing"
            git commit -m "Cycle harness artifacts [auto]"
            git push
          else
            # Try pushing any commits the harness or agent already made
            if [ "$(git rev-parse HEAD)" != "$(git rev-parse @{u})" ]; then
              echo "Unpushed commits found — pushing"
              git push
            else
              echo "No changes to push"
            fi
          fi
